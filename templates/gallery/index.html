{% extends 'base.html' %}

{% block body %}

  <div class='container'>
    <ul class='class-gallery'>
    {% for bio in bios %}
      <li class="profile-wrapper">
        <a class="profile">
          <img class="profile-image img-polaroid" src="{{bio.avatar}}">
          <!--span class="profile-bio">{{bio.bio}}</span-->
        </a>
      </li>
    {% endfor %}
    </ul>
  </div>

  <div class="container">
    <!-- if user not added yet, show form/button to add user -->
    {% if 1 %}
    <div class="row">
 
      <div class="profile-edit well span5">
        <h3>Fill in your data</h3>
        <div id="avatar-preview"></div>
        <form id="avatar-form" action="https://{{ AWS_S3_BUCKET }}.s3.amazonaws.com/" method="post" enctype="multipart/form-data">
          <input type="hidden" name="key" value = "">
          <input type="hidden" name="AWSAccessKeyId" value="{{ AWS_ACCESS_KEY_ID }}">
          <input type="hidden" name="acl" value="public-read">
          <input type="hidden" name="success_action_status" value="201">
          <input type="hidden" name="policy" value="{{ s3_policy }}">
          <input type="hidden" name="signature" value="{{ s3_signature }}">
          <input type="hidden" name="Content-Type" value="image/png">
          <input id="profile-pic-input" name="file" type="file">
        </form>
 
        <form id="bio-form" action="{% url gallery_save_bio %}" method="POST">
          {% csrf_token %}
          <input type="hidden" name="avatar">
          <div class="control-group">
            <label>Email</label>
            <div class="controls">
              <input type="text" name="email">
            </div>
          </div>
          <div class="control-group">
            <label>Name</label>
            <div class="controls">
              <input type="text" name="name">
            </div>
          </div>
          <div class="control-group">
            <label>Bio</label>
            <div class="controls">
              <input type="text" name="bio">
            </div>
          </div>
          <button class="btn btn-primary btn-block" type="submit">Submit</button>
        </form>
  
      </div>

      <div class="well span5">
        <h3>Use data from twitter</h3>
        <form id="twitter-form" action="{% url twitter_get_data %}" method="POST">
          {% csrf_token %}
          <label>Twitter handle</label><input type="text" name="twitter_handle">
          <button class="btn btn-primary btn-block">Get data from your twitter account</button>
        </form>
      </div>
    </div>
    {% endif %}
  </div>

{% endblock %}

{% block js %}
  <script>
    function getS3AvatarUrl(){
        var avatar_url = 'https://{{ AWS_S3_BUCKET }}.s3.amazonaws.com/';
        avatar_url = avatar_url + '{{ key_prefix }}';
        avatar_url = avatar_url + $('#profile-pic-input').val();
        return avatar_url;
    }

    function setAvatar(url){
        $('#avatar-preview').html('<img style="widht:120px;height:120px;" src="' + url + '">');
    }
    
    $(document).ready(function() {
      $('#profile-pic-input').change( function (e){
        // determine mime type and set "Content-Value" input
        var mime_type = e.target.files[0].type;
        $('#avatar-form :input[name=Content-Type]').val(mime_type);
        
        // set key value for uploaded file
        var key = '{{ key_prefix }}' + e.target.value;
        $('#avatar-form :input[name=key]').val(key);

        // upload image to Amazon S3
        var frm = $('#avatar-form');
        var form_data = new FormData(frm[0]);
        $.ajax({
          type: frm.attr('method'),
          url: frm.attr('action'),
          data: form_data,
          processData: false,
          contentType: false,
          cache: false,
          complete: function (req, msg){
            setAvatar(getS3AvatarUrl());
            $('#bio-form :input[name=avatar]').val(getS3AvatarUrl());
          }
        });
      });
      
      $("#bio-form").validate({
          debug: true,
          rules: {
              avatar: "required",
              email: "required",
              name: "required",
              bio: "required",
          },
          errorClass: "error",
          highlight: function (element, errorClass) {
              $(element).parents(".control-group").addClass(errorClass);
          },
          unhighlight: function (element, errorClass, validClass) {
              $(element).parents(".control-group").removeClass(errorClass);
          },
          errorPlacement: function () {
          },
          submitHandler: function (form) {
              form.submit();
          }
      });

      $('#twitter-form').submit(function(e){
          e.preventDefault();
          $.ajax({
              type: 'POST',
              url: $('#twitter-form').attr('action'),
              data: $('#twitter-form').serialize(),
              cache: false,
              success: function (data, textStatus, jqXHR){
                  var jsonData = $.parseJSON(data);
                  setAvatar(jsonData.avatar);
                  $('#bio-form :input[name=avatar]').val(jsonData.avatar);
                  $('#bio-form :input[name=name]').val(jsonData.name);
                  $('#bio-form :input[name=bio]').val(jsonData.bio);
              }
          });
      });

    });
  </script>
{% endblock %}
